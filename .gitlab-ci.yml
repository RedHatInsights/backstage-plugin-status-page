default:
  image: node:18
  tags: 
    - shared

stages:
  - build
  - test

build:
  stage: build
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends libsqlite3-dev python3 python3-pip build-essential
    - npm i -g corepack && corepack enable && corepack prepare yarn@3 --activate
    - yarn install
    - git config --global --add safe.directory /opt/app-root/src
  script:
    - yarn tsc
    - yarn build:all
  

test:
  image: mcr.microsoft.com/playwright:latest
  stage: test
  only:
    - schedules
  variables:
    TEST_URL: BASE_URL
    MATOMO_TEST_URL: $MATOMO_TEST_URL
    BRANCH_NAME: $CI_COMMIT_BRANCH
    BUILD_NUMBER: $CI_PIPELINE_ID
    SLACK_CHANNEL_LINK: $SLACK_CHANNEL_LINK
    REPORT_PORTAL_KEY: $REPORT_PORTAL_KEY
    REPORT_PORTAL_PROJECTNAME: $REPORT_PORTAL_PROJECTNAME
    REPORT_PORTAL_URL: $REPORT_PORTAL_URL
  before_script:
    - apt-get update
    - apt-get install build-essential -y
    - apt-get install libnss3-tools
    - apt-get install openjdk-8-jre-headless -y
    - mkdir -p $HOME/.pki/nssdb
    - cp ReportPortal.pem /usr/local/share/ca-certificates/
    - certutil -d $HOME/.pki/nssdb -N --empty-password
    - curl -k https://certs.corp.redhat.com/certs/2015-IT-Root-CA.pem --create-dirs -o  /usr/local/share/ca-certificates/2015-IT-Root-CA.pem
    - curl -k https://certs.corp.redhat.com/certs/2022-IT-Root-CA.pem --create-dirs -o  /usr/local/share/ca-certificates/2022-IT-Root-CA.pem
    - certutil -d sql:$HOME/.pki/nssdb -A -t "C,," -n root.implodingduck.local -i '/usr/local/share/ca-certificates/2015-IT-Root-CA.pem';
    - certutil -d sql:$HOME/.pki/nssdb -A -t "C,," -n ITCertificate -i '/usr/local/share/ca-certificates/2022-IT-Root-CA.pem';
    - certutil -d sql:$HOME/.pki/nssdb -A -t "C,," -n ReportPortalCertificate -i '/usr/local/share/ca-certificates/ReportPortal.pem';
    - openssl x509 -in ReportPortal.pem -inform pem -out ReportPortal.der -outform der
    - keytool -importcert -alias startssl -keystore /usr/lib/jvm/java-8-openjdk-amd64/jre/lib/security/cacerts -storepass changeit -file ReportPortal.der -noprompt

  script:
    - yarn install
    - yarn playwright install
    - npx playwright install msedge
    - source playwright/set-env.sh
    - yarn playwright test --workers 6
  artifacts:
    paths:  
      - ./playwright-report/
    when: always
 